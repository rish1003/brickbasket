{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BrickBasket</title>
    <link rel="stylesheet" href="{% static 'css/landing.css' %}">

    <script>
        const getIcon = (name, size = 20) => {
            const icons = {
                'mail': '<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline>',
                'lock': '<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path>',
                'eye': '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>',
                'eye-off': '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24M1 1l22 22"></path>',
                'user': '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>',
                'building': '<rect x="3" y="6" width="18" height="15" rx="2" ry="2"></rect><path d="M12 11V6"></path><path d="M9 11h6"></path><path d="M9 15h6"></path><path d="M9 19h6"></path>',
                'dollar': '<line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>',
            };
            return `<svg height="${size}" width="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${icons[name] || icons['eye']}</svg>`;
        };

        const showAlert = (title, message) => {
            const popup = document.getElementById('alert-popup');
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            popup.style.display = 'flex';
        };

        const closeAlert = () => {
            document.getElementById('alert-popup').style.display = 'none';
        };

        const showError = (inputElement, message) => {
            const inputForm = inputElement.closest('.inputForm');
            if (!inputForm) return;

            inputForm.classList.add('error');

            let errorMsg = inputForm.nextElementSibling;
            if (!errorMsg || !errorMsg.classList.contains('error-message')) {
                errorMsg = document.createElement('p');
                errorMsg.classList.add('error-message');
                inputForm.parentNode.insertBefore(errorMsg, inputForm.nextElementSibling);
            }

            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
        };

        const clearError = (inputElement) => {
            const inputForm = inputElement.closest('.inputForm');
            if (!inputForm) return;

            inputForm.classList.remove('error');

            const errorMsg = inputForm.nextElementSibling;
            if (errorMsg && errorMsg.classList.contains('error-message')) {
                errorMsg.style.display = 'none';
            }
        };

        const clearAllErrors = (form) => {
             form.querySelectorAll('input').forEach(input => clearError(input));
        };

        const showLoader = () => {
            document.getElementById('page-loader').style.display = 'flex';
        };

        const hideLoader = () => {
            document.getElementById('page-loader').style.display = 'none';
        };

        const togglePasswordVisibility = (element) => {

            const inputForm = element.closest('.inputForm');
            const passwordInput = inputForm ? inputForm.querySelector('input[type="password"], input[type="text"]') : null;

            if (passwordInput) {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    element.innerHTML = getIcon('eye-off'); 
                } else {
                    passwordInput.type = 'password';
                    element.innerHTML = getIcon('eye'); 
                }
            }
        };
    </script>
</head>
<body>
    <div id="alert-popup">
        <div id="alert-popup-content">
            <h3 id="alert-title">Error!</h3>
            <p id="alert-message">There was an issue processing your request.</p>
            <button onclick="closeAlert()">OK</button>
        </div>
    </div>
    <div class="container">
        <div class="image-section" id="imageSection" style="background: url('{% static 'images/landing.jpeg' %}') center/cover no-repeat;">
            <h1>BrickBasket</h1>
        </div>
        
        <div class="login-section" id="loginSection">
            
            <div class="form-section" id="roleSelectionSection">
                <div class="flex-column" style="text-align: center; padding: 40px 0;">
                    <h1>Join BrickBasket</h1>
                    <p style="margin-top: 10px; color: #555;">How will you be using our platform?</p>
                </div>
                <div style="
                    display: flex; 
                    flex-direction: column; 
                    gap: 25px; 
                    margin-top: 20px; 
                    width: 90%; 
                    max-width: 450px; 
                    margin: 20px auto;
                    padding-bottom: 50px;
                ">
                    <button class="role-button" data-role="customer" style="width: 100%; text-align: center; padding: 20px;">
                        <h2>Customer</h2>
                        <p style="font-size: 0.9em; margin-top: 5px;">Browse and purchase materials.</p>
                    </button>
                    <button class="role-button" data-role="vendor" style="width: 100%; text-align: center; padding: 20px;">
                        <h2>Vendor</h2>
                        <p style="font-size: 0.9em; margin-top: 5px;">List and sell construction materials.</p>
                    </button>
                </div>
            </div>
            
            <div class="form-section hidden-form" id="userSection">
                
                <div id="userSignInForm">
                    <form class="form">
                        <div class="flex-column" style="margin-bottom: 20px;">
                            <h1>Customer Sign In</h1>
                        </div>
                        
                        <div class="flex-column"><label>Email or Username </label></div>
                        <div class="inputForm">
                            <script>document.write(getIcon('mail'));</script>
                            <input type="text" name="username" class="input" placeholder="Enter your Email or Username" required>
                        </div>
                        
                        <div class="flex-column" style="margin-top: 15px;"><label>Password </label></div>
                        <div class="inputForm">
                            <script>document.write(getIcon('lock'));</script>
                            <input type="password" name="password" class="input" placeholder="Enter your Password" required>
                            <span class="password-toggle" onclick="togglePasswordVisibility(this);"><script>document.write(getIcon('eye'));</script></span> 
                        </div>
                        
                        <div class="flex-row" style="margin-top: 15px; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center;"><input type="checkbox" name="remember" value="on"><label style="margin-left: 5px; font-size: 0.9em;">Remember me </label></div>
                            {% comment %} <span class="span link-button" style="font-size: 0.9em;">Forgot password?</span> {% endcomment %}
                        </div> 
                        
                        <button class="button-submit" style="margin-top: 25px;">Sign In</button>
                        <p class="p" style="margin-top: 20px;">Don't have an account? <span class="span link-button" data-toggle="userSignUp"><strong>Sign Up</strong></span></p>
                        <p class="p" style="margin-top: 10px;"><span class="span link-button" data-toggle="roleSelect">← Change Role</span></p>
                    </form>
                </div>

                <div id="userSignUpForm" class="hidden-form">
                    <form class="form" novalidate>
                        <div class="flex-column" style="margin-bottom: 20px;"><h1>Customer Sign Up</h1></div>

                        <div class="flex-column"><label>First Name</label></div>
                        <div class="inputForm">
                            <script>document.write(getIcon('user'));</script>
                            <input type="text" name="first_name" class="input" placeholder="Enter your First Name" required>
                        </div>

                        <div class="flex-column" style="margin-top: 15px;"><label>Last Name</label></div>
                        <div class="inputForm">
                            <script>document.write(getIcon('user'));</script>
                            <input type="text" name="last_name" class="input" placeholder="Enter your Last Name" required>
                        </div>

                        

                        <div class="flex-column" style="margin-top: 15px;"><label>Email </label></div>
                        <div class="inputForm">
                            <script>document.write(getIcon('mail'));</script>
                            <input type="email" name="email" class="input" placeholder="Enter your Email" required>
                        </div>

                        <div class="flex-column" style="margin-top: 15px;"><label>Password </label></div>
                        <div class="inputForm">
                            <script>document.write(getIcon('lock'));</script>
                            <input type="password" name="password" id="user_password" class="input" placeholder="Create a Password" required minlength="8">
                            <span class="password-toggle" onclick="togglePasswordVisibility(this);"><script>document.write(getIcon('eye'));</script></span> 
                        </div>

                        <div class="flex-column" style="margin-top: 15px;"><label>Confirm Password </label></div>
                        <div class="inputForm">
                            <script>document.write(getIcon('lock'));</script>
                            <input type="password" name="confirm_password" id="user_confirm_password" class="input" placeholder="Re-enter Password" required>
                            <span class="password-toggle" onclick="togglePasswordVisibility(this);"><script>document.write(getIcon('eye'));</script></span> 
                        </div>

                        <button class="button-submit" style="margin-top: 25px;">Sign Up</button>
                        <p class="p" style="margin-top: 20px;">Already have an account? <span class="span link-button" data-toggle="userSignIn"><strong>Sign In</strong></span></p>
                        <p class="p" style="margin-top: 10px;"><span class="span link-button" data-toggle="roleSelect">← Change Role</span></p>
                    </form>
                </div>
            </div>
            
            <div class="form-section hidden-form" id="vendorSection">

                <div id="vendorSignInForm">
                    <form class="form">
                        <div class="flex-column" style="margin-bottom: 20px;">
                            <h1>Vendor Sign In</h1>
                        </div>
                        
                        <div class="flex-column"><label>Company Email </label></div>
                        <div class="inputForm">
                            <script>document.write(getIcon('mail'));</script>
                            <input type="email" name="email" class="input" placeholder="Enter Company Email" required>
                        </div>
                        
                        <div class="flex-column" style="margin-top: 15px;"><label>Password </label></div>
                        <div class="inputForm">
                            <script>document.write(getIcon('lock'));</script>
                            <input type="password" class="input" name="password" placeholder="Enter Password" required>
                            <span class="password-toggle" onclick="togglePasswordVisibility(this);"><script>document.write(getIcon('eye'));</script></span>
                        </div>

                        <div class="flex-row" style="margin-top: 15px; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center;"><input type="checkbox" name="remember" value="on"><label style="margin-left: 5px; font-size: 0.9em;">Remember me </label></div>
                            {% comment %} <span class="span link-button" style="font-size: 0.9em;">Forgot password?</span> {% endcomment %}
                        </div> 
                        
                        <button class="button-submit" style="margin-top: 25px;">Vendor Sign In</button>
                        <p class="p" style="margin-top: 20px;">New vendor? <span class="span link-button" data-toggle="vendorSignUp"><strong>Sign Up Here</strong></span></p>
                        <p class="p" style="margin-top: 10px;"><span class="span link-button" data-toggle="roleSelect">← Change Role</span></p>
                    </form>
                </div>

                <div id="vendorSignUpForm" class="hidden-form">
                    <form class="form" novalidate>
                        <div class="flex-column" style="margin-bottom: 20px;"><h1>Vendor Sign Up</h1></div>
                        
                        <div class="flex-column"><label>Company Name </label></div>
                        <div class="inputForm">
                            <script>document.write(getIcon('building'));</script>
                            <input type="text" name="company_name" class="input" placeholder="Brick & Co." required>
                        </div>

                        <div class="flex-column" style="margin-top: 15px;"><label>Official Email </label></div>
                        <div class="inputForm">
                            <script>document.write(getIcon('mail'));</script>
                            <input type="email" name="email" class="input" placeholder="contact@brickco.com" required>
                        </div>

                        <div class="flex-column" style="margin-top: 15px;"><label>Business GST Number </label></div>
                        <div class="inputForm">
                            <script>document.write(getIcon('dollar'));</script>
                            <input type="text" name="gst_number" class="input" placeholder="e.g., V456789ABC" required>
                        </div>
                        
                        <div class="flex-column" style="margin-top: 15px;"><label>Password </label></div>
                        <div class="inputForm">
                            <script>document.write(getIcon('lock'));</script>
                            <input type="password" name="password" id="vendor_password" class="input" placeholder="Create a Secure Password" required minlength="8">
                            <span class="password-toggle" onclick="togglePasswordVisibility(this);"><script>document.write(getIcon('eye'));</script></span> 
                        </div>
                        
                        <div class="flex-column" style="margin-top: 15px;"><label>Confirm Password </label></div>
                        <div class="inputForm">
                            <script>document.write(getIcon('lock'));</script>
                            <input type="password" name="confirm_password" id="vendor_confirm_password" class="input" placeholder="Re-enter Password" required>
                            <span class="password-toggle" onclick="togglePasswordVisibility(this);"><script>document.write(getIcon('eye'));</script></span> 
                        </div>
                        
                        <button class="button-submit" style="margin-top: 25px;">Register Vendor</button>
                        <p class="p" style="margin-top: 20px;">Already registered? <span class="span link-button" data-toggle="vendorSignIn"><strong>Sign In</strong></span></p>
                        <p class="p" style="margin-top: 10px;"><span class="span link-button" data-toggle="roleSelect">← Change Role</span></p>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <div id="page-loader">
        <div class="spinner"></div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
          const lastLogin = localStorage.getItem("last_login_id");
          if (lastLogin) {
              const userInput = document.querySelector('#userSignInForm input[name="username"]');
              if (userInput) userInput.value = lastLogin;

              const vendorInput = document.querySelector('#vendorSignInForm input[name="email"]');
              if (vendorInput) vendorInput.value = lastLogin;
          }
            const imageSection = document.getElementById("imageSection");
            const loginSection = document.getElementById("loginSection");

            const roleSelectionSection = document.getElementById("roleSelectionSection");
            const userSection = document.getElementById("userSection");
            const vendorSection = document.getElementById("vendorSection");

            const userSignInForm = document.getElementById("userSignInForm");
            const userSignUpForm = document.getElementById("userSignUpForm");

            const vendorSignInForm = document.getElementById("vendorSignInForm");
            const vendorSignUpForm = document.getElementById("vendorSignUpForm");

            const navTriggers = document.querySelectorAll('[data-role], [data-toggle]');

            setTimeout(() => {
                imageSection.style.width = "50%";
                loginSection.style.width = "50%";
                loginSection.style.opacity = "1";
            }, 1000);

            function hideAllSections() {
                roleSelectionSection.classList.add("hidden-form");
                userSection.classList.add("hidden-form");
                vendorSection.classList.add("hidden-form");
            }

            function hideAllForms() {
                userSignInForm.classList.add("hidden-form");
                userSignUpForm.classList.add("hidden-form");
                vendorSignInForm.classList.add("hidden-form");
                vendorSignUpForm.classList.add("hidden-form");
            }

            let selectedRole = "customer";

            navTriggers.forEach(element => {
                element.addEventListener("click", () => {
                    const role = element.getAttribute("data-role");
                    const toggle = element.getAttribute("data-toggle");
                    if (role || toggle) {
                         const activeForm = document.querySelector('.form-section:not(.hidden-form) .form:not(.hidden-form)');
                         if (activeForm) clearAllErrors(activeForm);
                    }

                    if (role) {
                        hideAllSections();
                        selectedRole = role;

                        if (role === "customer") {
                            userSection.classList.remove("hidden-form");
                            hideAllForms();
                            userSignInForm.classList.remove("hidden-form");
                        } else if (role === "vendor") {
                            vendorSection.classList.remove("hidden-form");
                            hideAllForms();
                            vendorSignInForm.classList.remove("hidden-form");
                        }
                    } else if (toggle) {
                        if (toggle === "roleSelect") {
                            hideAllSections();
                            roleSelectionSection.classList.remove("hidden-form");
                        }

                        if (toggle === "userSignUp") {
                            userSignInForm.classList.add("hidden-form");
                            userSignUpForm.classList.remove("hidden-form");
                        } else if (toggle === "userSignIn") {
                            userSignUpForm.classList.add("hidden-form");
                            userSignInForm.classList.remove("hidden-form");
                        }

                        if (toggle === "vendorSignUp") {
                            vendorSignInForm.classList.add("hidden-form");
                            vendorSignUpForm.classList.remove("hidden-form");
                        } else if (toggle === "vendorSignIn") {
                            vendorSignUpForm.classList.add("hidden-form");
                            vendorSignInForm.classList.remove("hidden-form");
                        }
                    }
                });
            });
            const isValidEmail = (email) => {
                const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                return re.test(String(email).toLowerCase());
            };

            const isPasswordStrong = (password) => {
                const re = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
                return re.test(String(password));
            };

            const validateSignupForm = (form) => {
                const inputs = form.querySelectorAll('input[required]');
                let isValid = true;
                clearAllErrors(form);
                for (let i = 0; i < inputs.length; i++) {
                    const input = inputs[i];
                    
                    if (!input.value.trim()) {
                        showError(input, `This field is required.`);
                        input.focus();
                        isValid = false;
                        return false;
                    }
                    if (input.type === 'email' && !isValidEmail(input.value)) {
                        showError(input, `Please enter a valid email address.`);
                        input.focus();
                        isValid = false;
                        return false;
                    }
                };

                if (!isValid) return false;
                const passwordInput = form.querySelector('input[name="password"]');
                const confirmPasswordInput = form.querySelector('input[name="confirm_password"]');

                if (passwordInput && confirmPasswordInput) {
                    if (!isPasswordStrong(passwordInput.value)) {
                        showError(passwordInput, "Must be 8+ chars, 1 uppercase, 1 lowercase, 1 number, and 1 special char (@$!%*?&).");
                        passwordInput.focus();
                        return false;
                    }
                    if (passwordInput.value !== confirmPasswordInput.value) {
                        showError(confirmPasswordInput, "Passwords do not match.");
                        confirmPasswordInput.focus();
                        return false;
                    }
                }
                
                return true;
            };
            document.querySelectorAll('.form input').forEach(input => {
                input.addEventListener('input', () => {
                    clearError(input);
                });
            });

            const allSignupForms = document.querySelectorAll("#userSignUpForm form, #vendorSignUpForm form");
            allSignupForms.forEach(form => {
                form.addEventListener("submit", async e => {
                    e.preventDefault();

                    if (!validateSignupForm(form)) {
                        return; 
                    }
                    
                    clearAllErrors(form); 
                    showLoader(); 
                    const formData = Object.fromEntries(new FormData(e.target).entries());
                    formData.role = selectedRole;

                    try {
                        const response = await fetch("signup/", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(formData),
                        });
                        
                        hideLoader();

                        if (response.status === 200) {
                            const result = await response.json(); 
                            if (result.redirect_url) {
                                window.location.href = result.redirect_url;
                            } else {
                                showAlert("Registration Success", "Account created successfully, but no redirect URL provided. Check console for details.");
                            }
                        } else {
                            const errorResult = await response.json();
                            showAlert("Registration Failed", errorResult.message || 'Server error occurred during sign up. Please try again.');
                        }

                    } catch (err) {
                        console.error(err);
                        hideLoader(); 
                        showAlert("Network Error", "Signup failed due to network or application error. Please check your connection and try again.");
                    }
                });
            });
            const allSignInForms = document.querySelectorAll("#userSignInForm form, #vendorSignInForm form");
            allSignInForms.forEach(form => {
                form.addEventListener("submit", async e => {
                    e.preventDefault();
                    
                    clearAllErrors(form); 
                    showLoader(); 

                    const formData = Object.fromEntries(new FormData(e.target).entries());
                    formData.role = selectedRole;

                    try {
                        const response = await fetch("signin/", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(formData),
                        });
                        
                        hideLoader(); 

                        if (response.status === 200) {
                            const result = await response.json(); 
                            if (result.redirect_url) {
                              if (formData.username) {
                                  localStorage.setItem("last_login_id", formData.username);
                              }
                              if (formData.email) {
                                  localStorage.setItem("last_login_id", formData.email);
                              }
                                window.location.href = result.redirect_url;
                            } else {
                                showAlert("Sign In Success", "Sign in successful, but no redirect URL provided.");
                            }
                        } else {
                            const errorResult = await response.json();
                            showAlert("Sign In Failed", errorResult.message || 'Invalid credentials or server error. Please check your inputs.');
                            
                            form.querySelector('input[name="username"]')?.closest('.inputForm')?.classList.add('error');
                            form.querySelector('input[name="email"]')?.closest('.inputForm')?.classList.add('error');
                            form.querySelector('input[name="password"]')?.closest('.inputForm')?.classList.add('error');
                        }

                    } catch (err) {
                        console.error(err);
                        hideLoader(); 
                        showAlert("Network Error", "Sign-in failed due to network or application error. Please try again.");
                    }
                });
            });
        });
    </script>
</body>
</html>